% 
% To update manual.html use latexmk -pdf; pdf2htmlEX --zoom 2.5 kunisch.pdf
% 
\documentclass[A4]{article}

% wider page:
% 
\usepackage[a4paper,includeheadfoot,margin=2.54cm]{geometry} 

\usepackage{navigator}
\newcommand{\url}[2]{\urllink{#1}{\textbf{\textcolor{red}{#2}}}}
\newcommand{\link}[2]{\jumplink{#1}{\textbf{\textcolor{blue}{#2}}}}


\usepackage{amsthm}
\usepackage{amsmath}      
\usepackage{amsfonts}           
\usepackage{amssymb}

\input{../../LaTeX/listings_julia}
\lstset{rangeprefix=\#\ [,rangesuffix=],includerangemarker=false}

\usepackage[ruled,vlined,algonl]{algorithm2e}   

\usepackage{framed} % http://tex.stackexchange.com/questions/26269/border-or-frame-around-figure

% ================================================================

\begin{document}

\title{A simple bound constrained quadratic optimizer in Julia}
\author{\url{https://pixorblog.wordpress.com/}{Pixor Blog}}
\date{}
\maketitle

% ================================================================

\section{A simple bound constrained quadratic optimizer in Julia}

\subsection{Problem description}

The goal is to minimize a bound constrained quadratic form where $Q$ is a symmetric definite positive matrix.
\begin{equation}
  \label{eq:toMinimize}
  \min\limits_{a\le x \le b} \frac{1}{2} x^t.Q.x + q^t.x
\end{equation}

For well conditioned problems the
\url{http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.31.8006}{Kunisch}
method is a quite effective method which is also intuitive and easy to
implement.

The idea of the method is to guess active constraints, computes the
associated solution with its a posteriori multipliers. Then we check
the validity of our initial guess and we make the necessary
corrections and we restart with this new guess. It can be shown, in
exact arithmetic, that this process ends in a finite number of
iterations.

To do this we need to write the Lagragian associated to problem

\begin{equation*}
  \mathcal{L} = \frac{1}{2} x^t.Q.x + q^t.x + \lambda^t (a-x) + \mu^t (x-b)
\end{equation*}

and its gradient

\begin{equation*}
  \nabla_x \mathcal{L} = Q.x + q -\lambda + \mu = Q.x+q+\tau = 0
\end{equation*}
with $\tau =  -\lambda + \mu$ storing multipliers associated to the constraints $x\in[a,b]$

The KKT conditions are
\begin{equation*}
  \nabla_x \mathcal{L} = Q.x+q-\lambda+\mu =0
\end{equation*}
\begin{equation*}
  (\lambda \ge 0)\wedge(\lambda\odot(a-x))=0 
\end{equation*}
\begin{equation*}
  (\mu \ge 0)\wedge(\mu\odot(x-b))=0
\end{equation*}

We introduce a $Z\in\{-1,0,1\}^n$ vector to encode our guess on which contraints are active or not:

\begin{equation*}
  Z_i = \left\{
    \begin{array}{c|c|cc}
      -1 & x_i=a_i & \lambda_i = -\tau_i &  \mu_i = 0 \\
      0  & a_i \le x_i \le b_i & \lambda_i = 0 & \mu_i = 0 \\
      +1 &  x_i=b_i & \lambda_i = 0 &  \mu_i = \tau_i \\
    \end{array}
  \right.
\end{equation*} 

The algorithm takes the following form:

\begin{algorithm}[H]
\caption{Kunisch method}
  \KwData{\\
    $Z^{(0)}\in\{-1,01\}^n$ initial guess\\
    $x^{(0)}$ initial guess
  }
  \KwResult{\\
    $x^{(k)}$ and $\tau^{(k)}$ solution of the problem
  }
  \Repeat{$Z^{(k)}\neq Z^{(k+1)}$}{
    \tcp{step 1: Modifies $Q$ and $q$ such that $\tilde{x}^{(k)}$ fulfills active constraints}
    $$
      \tilde{x}^{(k)}= \arg\min\limits_{x}\frac{1}{2} x^t.\tilde{Q}.x + \tilde{q}^t.x
      $$
    $$
    \begin{array}{lll}
      x_i=a_i & \text{if} & Z_i=-1 \\ 
      x_i=b_i & \text{if} & Z_i=+1
    \end{array}
    $$

    \tcp{step 2: compute Multiplicateurs a posteriori:}
    $$
    \tau^{(k)} = -( Q.\tilde{x}^{(k)}+q )
    $$

    \tcp{step 3: Update $Z$ (corrections -> our new guess)}
    \begin{equation}
    \begin{array}{lrc}
      
      \text{If\ }Z_i^{(k)}=-1 & \text{then} & Z_i^{(k+1)}=
      \left\{
      \begin{array}{rl}
        -1 & \text{if\ }\tau_i\le 0 \\
        0 & \text{otherwise}
      \end{array}
      \right.  \\

      \text{If\ }Z_i^{(k)}=0 & \text{then} & Z_i^{(k+1)}=
      \left\{
      \begin{array}{rl}
        -1 & \text{if\ }x_i<a_i \\
        0 & \text{if\ }a_i\le x_i  \le b_i \\
        +1 & \text{if\ }b_i<x_i
      \end{array}
      \right.  \\

      \text{If\ }Z_i^{(k)}=+1 & \text{then} & Z_i^{(k+1)}=
      \left\{
      \begin{array}{rl}
        1 & \text{if\ }\tau_i\ge 0 \\
        0 & \text{otherwise}
      \end{array}
      \right.  \\
      
    \end{array}
    \label{eq:UpdateZ}
    \end{equation}
  }
\end{algorithm}

\section{Implementation}

\subsection{Step 1 : modification of Eq. \ref{eq:toMinimize}}

Once can modify Eq. \ref{eq:toMinimize} to explicitly enforce \textbf{active constraints}:

\begin{equation}
\label{Eq_Build_Qtilde}
\tilde{Q}^{(k)}_{i,j}=
\left\{
\begin{array}{rl}
  Q_{i,j} & \text{si\ }Z^{(k)}_i=0\text{\ et\ }Z^{(k)}_j=0 \\
  \delta_{i,j} & \text{sinon}  
\end{array}
\right.
\end{equation}
et
\begin{equation}
\label{Eq_Build_qtilde}
\tilde{q}^{(k)}_i=
\left\{
\begin{array}{rl}
q_i+\sum\limits_{j,\ Z_j=-1}a_jQ_{i,j} + \sum\limits_{j,\ Z_j=1}b_jQ_{i,j} & \text{si\ }Z^{(k)}_i=0 \\
-a_i & \text{si\ }Z^{(k)}_i=-1 \\
-b_i & \text{si\ }Z^{(k)}_i=+1 \\
\end{array}
\right.
\end{equation}

In Julia this can be done as in \link{lst:Modify_Qq}{Step 1
  implementation}. We have not tried to optimize the code, you can add
\textcolor{blue}{\textbf{@simd}} and \textcolor{blue}{\textbf{@inbounds}} if you
want. More importantly we have defined this function for dense
symmetric matrices, but you can extend the presented code by defining
specializations for banded or tridiagonal matrices.

\begin{figure}[ht]
  \begin{framed}
    \lstinputlisting[language=Julia,linerange=Modify_Qq-Modify_Qq]{./kunisch.jl}
  \end{framed}
  \caption{Step 1 implementation}
  \anchor{lst:Modify_Qq}
\end{figure}

\subsection{Step 2 : compute solution and a posteriori multipliers}

The code is really simple \link{lst:Solution}{Step 2
  implementation}. Again there is room for optimization, in particular
there is no need to duplicate \textcolor{blue}{\textbf{q}}, this can
be done inplace by overwriting \textcolor{blue}{\textbf{x}}.

\begin{figure}[ht]
  \begin{framed}
    \lstinputlisting[language=Julia,linerange=Solution-Solution]{./kunisch.jl}
  \end{framed}
  \caption{Step 2 implementation}
  \anchor{lst:Solution}
\end{figure}

\subsection{Step 3 : update Z}

We use the a posteriori multipliers $\tau$ to update our guess. The code is given \link{lst:UpdateZ}{Step 3
  implementation}. We just follow Eq. \ref{eq:UpdateZ}.

\begin{figure}[ht]
  \begin{framed}
    \lstinputlisting[language=Julia,linerange=UpdateZ-UpdateZ]{./kunisch.jl}
  \end{framed}
  \caption{Step 3 implementation}
  \anchor{lst:UpdateZ}
\end{figure}

\subsection{The Kunisch solver}

Putting everything together gives the \link{lst:Kunisch}{complete Kunisch function}
\begin{figure}[ht]
  \begin{framed}
    \lstinputlisting[language=Julia,linerange=Kunisch-Kunisch]{./kunisch.jl}
  \end{framed}
  \caption{Complete Kunisch function}
  \anchor{lst:Kunisch}
\end{figure}

\section{Some tests}
In the \link{sec:Readings}{Readings} section you can find some
application. Here we provide an exemple involving an \url{https://en.wikipedia.org/wiki/Hilbert_matrix}{Hilbert matrix}
which is a canonical example of ill-conditioned matrices
\begin{framed}
  \lstinputlisting[language=Julia]{./demo.jl}
\end{framed}

I personnaly use this method to define a \url{https://en.wikipedia.org/wiki/Levenberg-Marquardt_algorithm}{Levenbergâ€“Marquardt algorithm} with constraints.
Maybe another post... 

\section{Readings}
\anchor{sec:Readings} 

The original article
\url{http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.31.8006}{An Infeasible Active Set Method for Convex Problems With Simple Bounds}

An extension of the method
\url{http://philipphungerlaender.jimdo.com/qp-code/}{mKR: A Code for Convex Quadratic Programs with Box-Constraints}

One MatLab implementation with examples:
\url{http://www.cs.uoi.gr/~voglis/boxcqp.pdf}{BOXCQP: An Algorithm for Bound Constrained Convex Quadratic Problems}

This last reference shows how one can tackle problem of the form
$$
\min\limits_{A.x\ge b} \frac{1}{2} x^t.Q.x + q^t.x
$$
using %\url{https://en.wikipedia.org/wiki/Duality_%28optimization%29}{duality theory}.

% \bibliography{../bibliography.bib}

\end{document}
